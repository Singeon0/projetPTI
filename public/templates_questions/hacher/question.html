<!DOCTYPE html>
<html lang="fr">


<head>
    <meta charset="UTF-8">
    <title id="htmlTitle"></title>
    <link rel="stylesheet" href="../style_prof.css">
</head>

<body>
    <h1>Hachurer la figure pour qu'elle représente la fraction annoncée</h1>
    <h2 id="questionnaireName"> </h2>
    <p>Cliquez sur le point pour modifier le coloriage et recliquez pour valider</p>
    <canvas id="canvas" width="1800" height="800"></canvas>
    <button id="validateButton" class="save-button">Valider l'appariement</button>
    <img src="/templates_questions/images/hachure1-rect.PNG" alt="image" id="hachure1_img_rect" style="display:none">
    <img src="/templates_questions/images/hachure1-cercle.PNG" alt="image" id="hachure1_img_cercle" style="display:none">
    <img src="/templates_questions/images/latte.jpg" alt="image" id="latte_hachure_img" style="display:none">

    <script>
        
        let left = []; // tableau des points à gauche -> permet d'accèder au contenu hors du main
        let idQuestion = 1086;
        // Charger le fichier JSON
        function loadJSON(idQuestion, callback) {
            fetch(`/api/get_question/${idQuestion}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    callback(null, data);
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du fichier JSON:', error);
                    callback(error);
                });
        }

        function updateTitle(title) {
            document.getElementById("questionnaireName").textContent = title;
        }

              // Récupérer le contexte du canvas
              let canvas = document.getElementById("canvas");
              let ctx = canvas.getContext("2d");
              let selectX_rect = 35, selectY_rect = 400;
                var tolerance_hachure1 = 500;

            
        function main() {
            loadJSON(idQuestion, (error, propositions) => {
                if (error) {
                    return;
                }

                // Mettre à jour le titre <h1> avec la valeur de propositions.questionnaireName
                updateTitle(propositions.questionnaireName);

              

                // Définir les paramètres des points
                let radius = 10; // rayon des points
                let gap = 30; // espace entre les points
                let right = []; // tableau des points à droite
                let selected = null; // point sélectionné
                const decalage =200;
                const forme = propositions.forme;
                const fraction_numerateur=  propositions.fraction_numerateur;
                const fraction_denominateur = propositions.fraction_denominateur;
                //////////////////////////////////////////////////////////////////////////

            });

              canvas.addEventListener('click',(e)=>{
                console.log(canvas.offsetTop)
                console.log("x : " + (e.clientX  -parseInt(canvas.offsetLeft)))
                console.log("y : " + (e.clientY - parseInt(canvas.offsetTop)))
            })
       
           
              
                interval_hachure1()
        }
                function interval_hachure1(){
                    HEIGHT = 650;
                    document.getElementById("canvas").style.height = "650px";
                    document.getElementById("canvas").addEventListener("click", select_hachure1);
                

              //  drawBoard();
                drawImage_hachure1();
                initialisation_hachure1();
                }
                function drawImage_hachure1(){
                    var temp_image = document.getElementById("hachure1_img_rect");
                    ctx.drawImage(temp_image, 5, 40, 1180, 500);
                    var temp_image = document.getElementById("latte_hachure_img");
                    ctx.drawImage(temp_image, 35, 550,1173,150);
                }
                function initialisation_hachure1(){
                    ctx.beginPath();
                    ctx.arc(50, 500, 20, 0, 200, false);
                    ctx.fillStyle = "black";
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(50, 500, 17, 0, 200, false);
                    ctx.fillStyle = "white";
                    ctx.fill();
                }
                function select_hachure1(e){
                  
                    var x = parseInt(e.clientX -document.getElementById("canvas").offsetLeft);
                    var y = parseInt(e.clientY - document.getElementById("canvas").offsetTop);
                    console.log(x)
                    console.log(y)
                   
                    if(x > selectX_rect -tolerance_hachure1 && x < selectX_rect + tolerance_hachure1){
                        if(y > selectY_rect - tolerance_hachure1 && y < selectY_rect + tolerance_hachure1){
                            console.log("bite")
                            document.getElementById("canvas").addEventListener("mousemove", hachure1_rect)
                            document.getElementById("canvas").removeEventListener("click", select_hachure1);
                            document.getElementById("canvas").addEventListener("click", hachure1_rect_stop);
                        }}
                      
                }
                
                
                
                function hachure1_rect(e){
                
                    
                    mouseX = parseInt(e.pageX - document.getElementById("canvas").offsetLeft)-35;
                    mouseY = parseInt(e.pageY - document.getElementById("canvas").offsetTop)-20;
                    if(e !== false){
                        selectX_rect = mouseX;
                        if(selectX_rect < 52){
                            selectX_rect = 52;
                        }
                        if(selectX_rect > 1170){
                            selectX_rect = 1170;
                        }   
                        drawImage_hachure1();
                        
                    }
                    ctx.globalAlpha = 0.5;
                    ctx.beginPath();
                    ctx.fillStyle = "green";
                    ctx.fillRect(52, 85, selectX_rect-52,423)
                    ctx.globalAlpha = 1;
                    ctx.beginPath();
                    ctx.arc(selectX_rect, selectY_rect, 20, 0, 200, false);
                    ctx.fillStyle = "black";
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(selectX_rect, selectY_rect, 17, 0, 200, false);
                    ctx.fillStyle = "white";
                    ctx.fill();

                }
                function hachure1_rect_stop(){
                    document.getElementById("canvas").removeEventListener("mousemove", hachure1_rect)
                document.getElementById("canvas").removeEventListener("click", hachure1_rect_stop);
                document.getElementById("canvas").addEventListener("click", select_hachure1);
                }
                
                    
                function score_hachure1(){
                
                if(selectX_rect > 115 && selectX_rect < 165){
                    sendData(1, "hachure", 1, 1)
                }else{
                    if(selectX_rect < 85){
                        sendData(9, "hachure", 1, 1)
                    }else{
                        sendData(0, "hachure", 1, 1)
                    }
                }
                if(rads_hexa < -0.87 && rads_hexa > -1.3){
                    sendData(1, "hachure", 1, 3)

                }else{
                    if(rads_hexa < 0.02 && rads_hexa > -0.02){
                        sendData(9, "hachure", 1, 3)
                    }else{
                        sendData(0, "hachure", 1, 3)
                    }}
                if(rads_rond > -1.82 && rads_rond < -1.18){
                    sendData(1, "hachure", 1, 2)

                }else{
                    if(rads_rond < 0.02 && rads_rond > -0.02){
                        sendData(9, "hachure", 1, 2)
                    }else{
                        sendData(0, "hachure", 1, 2)
                    }}
                    nettoyer_hachure1();
                }
                function nettoyer_hachure1(){
                  
                    document.getElementById("canvas").removeEventListener("mousemove", hachure1_rect)
                    document.getElementById("canvas").removeEventListener("click", hachure1_rect_stop);
                    
                    document.getElementById("canvas").removeEventListener("click", select_hachure1);
                    drawBoard();
                    reference_liste(2);
                }

                


               

                ////////////////////////////////////////////////////////////////////////////////////:

                // Gérer le clic sur le canvas
                

                // Ajoutez cet écouteur d'événement pour le bouton "Valider l'appariement" à la fin de la fonction main()
                document.getElementById("validateButton").addEventListener("click", saveResults);
        

        function saveQuestionToServer(questionJSON) {
            fetch("/api/save_json", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(questionJSON) // Convertir l'objet en chaîne JSON
            }).then((response) => {
                if (response.ok) {
                    alert("Question sauvegardée avec succès !");
                } else {
                    alert("Erreur lors de la sauvegarde de la question.");
                }
            });
        }


        // Ajoutez cette fonction pour enregistrer les résultats
        function saveResults() {
            const results = {};

            for (const point of left) {
                if (point.connectedTo) {
                    results[point.propLinked] = point.connectedTo.propLinked;
                }
            }

            // Télécharger le fichier JSON
            saveQuestionToServer(results);
        }
        window.onload = () => {  console.log(localStorage.getItem("question"));
                main();
            }
        
      
    </script>
</body>

</html>